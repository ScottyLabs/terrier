{
  "version": "1",
  "services": {
    "postgres": {
      "name": "postgres",
      "image": "postgres:17",
      "env": {
        "POSTGRES_DB": "terrier",
        "POSTGRES_USER": "terrier",
        "POSTGRES_PASSWORD": "${POSTGRES_PASSWORD}"
      },
      "volumes": [
        {
          "mountPath": "/var/lib/postgresql/data",
          "name": "postgres_data"
        }
      ],
      "ports": [5432],
      "healthcheck": {
        "test": ["CMD-SHELL", "pg_isready -U terrier"],
        "interval": "10s",
        "timeout": "5s",
        "retries": 5
      }
    },
    "pgadmin": {
      "name": "pgadmin",
      "image": "dpage/pgadmin4:latest",
      "env": {
        "PGADMIN_DEFAULT_EMAIL": "${PGADMIN_EMAIL:-admin@terrier.local}",
        "PGADMIN_DEFAULT_PASSWORD": "${PGADMIN_PASSWORD}",
        "PGADMIN_ALLOW_SPECIAL_EMAIL_DOMAINS": "local",
        "PGADMIN_CONFIG_SERVER_MODE": "False"
      },
      "volumes": [
        {
          "mountPath": "/var/lib/pgadmin",
          "name": "pgadmin_data"
        }
      ],
      "ports": [8080],
      "depends_on": ["postgres"],
      "restart": "unless-stopped"
    },
    "migration": {
      "name": "migration",
      "build": {
        "context": "./terrier-backend",
        "dockerfile": "Dockerfile"
      },
      "env": {
        "DATABASE_URL": "postgres://terrier:${POSTGRES_PASSWORD}@postgres:5432/terrier"
      },
      "depends_on": ["postgres"],
      "command": ["migration"],
      "profiles": ["migration"]
    },
    "minio": {
      "name": "minio",
      "image": "minio/minio:latest",
      "command": ["server", "/data", "--console-address", ":9001"],
      "env": {
        "MINIO_ROOT_USER": "${MINIO_ROOT_USER:-minioadmin}",
        "MINIO_ROOT_PASSWORD": "${MINIO_ROOT_PASSWORD}"
      },
      "ports": [9000, 9001],
      "volumes": [
        {
          "mountPath": "/data",
          "name": "minio_data"
        }
      ],
      "healthcheck": {
        "test": ["CMD", "mc", "ready", "local"],
        "interval": "5s",
        "timeout": "5s",
        "retries": 5
      },
      "restart": "unless-stopped"
    },
    "backend": {
      "name": "backend",
      "build": {
        "context": "./terrier-backend",
        "dockerfile": "Dockerfile"
      },
      "env": {
        "APP_URL": "${APP_URL:-http://localhost:1420}",
        "API_URL": "${API_URL:-http://localhost:3000}",
        "DATABASE_URL": "postgres://terrier:${POSTGRES_PASSWORD}@postgres:5432/terrier",
        "S3_ENDPOINT": "http://minio:9000",
        "S3_ACCESS_KEY": "${MINIO_ROOT_USER:-minioadmin}",
        "S3_SECRET_KEY": "${MINIO_ROOT_PASSWORD}",
        "S3_BUCKET_NAME": "${S3_BUCKET_NAME:-terrier-files}",
        "S3_REGION": "us-east-1",
        "OIDC_ISSUER": "${OIDC_ISSUER}",
        "OIDC_CLIENT_ID": "${OIDC_CLIENT_ID}",
        "OIDC_CLIENT_SECRET": "${OIDC_CLIENT_SECRET}",
        "ADMIN_EMAILS": "${ADMIN_EMAILS}",
        "RUST_LOG": "${RUST_LOG:-info}"
      },
      "ports": [3000],
      "depends_on": ["postgres", "minio"],
      "healthcheck": {
        "test": ["CMD", "curl", "-f", "http://localhost:3000/health"],
        "interval": "10s",
        "timeout": "5s",
        "retries": 5
      },
      "restart": "unless-stopped"
    },
    "frontend": {
      "name": "frontend",
      "build": {
        "context": "./terrier-client",
        "dockerfile": "Dockerfile"
      },
      "env": {
        "VITE_API_URL": "${API_URL:-http://localhost:3000}",
        "NODE_ENV": "production"
      },
      "ports": [1420],
      "depends_on": ["backend"],
      "restart": "unless-stopped"
    }
  },
  "volumes": {
    "postgres_data": {
      "name": "postgres_data"
    },
    "pgadmin_data": {
      "name": "pgadmin_data"
    },
    "minio_data": {
      "name": "minio_data"
    }
  }
}
